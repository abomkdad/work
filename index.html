<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD Smart Contract - Editable</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #D4AF37; 
            --dark: #2c3e50; 
            --light: #f8f9fa;
            --success: #27ae60;
        }
        
        body { margin: 0; padding: 0; font-family: 'Assistant', sans-serif; background: var(--light); color: #333; }
        
        /* --- 1. Admin Panel --- */
        #adminView { 
            max-width: 600px; margin: 20px auto; background: white; padding: 20px; 
            border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: block;
        }
        .admin-header { text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* Text Editor Style */
        .text-editor {
            width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            font-family: 'Assistant', sans-serif; font-size: 14px; line-height: 1.5; resize: vertical;
            background: #fafafa; margin-bottom: 10px;
        }
        .toggle-edit-btn {
            background: #eee; color: #333; border: none; padding: 8px; width: 100%;
            cursor: pointer; font-weight: bold; border-radius: 5px; margin-bottom: 10px;
        }

        .btn-main { 
            width: 100%; padding: 15px; background: var(--primary); border: none; 
            border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; color: black;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- 2. Employee Wizard --- */
        #employeeView { display: none; height: 100vh; flex-direction: column; }
        .wizard-header { background: var(--dark); color: white; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; position: sticky; top: 0; z-index: 100; }
        .step-container { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        .step-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .step-desc { text-align: center; color: #666; margin-bottom: 30px; }
        .info-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .info-label { font-weight: bold; color: #555; }
        
        .big-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 20px; margin-bottom: 15px;
            border: 2px dashed #ccc; border-radius: 12px; background: white;
            font-size: 18px; font-weight: bold; color: #555; cursor: pointer;
        }
        .big-btn.done { border-color: var(--success); color: var(--success); background: #e8f8f5; border-style: solid; }
        
        .nav-bar { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .btn-next { background: var(--dark); color: white; }
        .btn-prev { background: #eee; color: #333; }

        /* --- 3. Signature Modal --- */
        #sigModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; padding: 10px; box-sizing: border-box; }
        .modal-box { background: white; padding: 10px; border-radius: 10px; height: 70%; display: flex; flex-direction: column; }
        canvas { flex: 1; width: 100%; background: #f0f0f0; border: 2px solid #ccc; touch-action: none; border-radius: 5px; }
        .sig-toolbar { padding-top: 10px; display: flex; gap: 10px; }

        /* --- 4. Final Preview (A4) --- */
        #previewContainer { display: none; background: #555; padding: 10px; min-height: 100vh; }
        .a4-page {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm;
            box-sizing: border-box; position: relative; 
        }
        /* Make content editable look normal */
        [contenteditable="true"] { outline: none; }
        [contenteditable="true"]:hover { background: #fffbe6; cursor: text; }

        @media screen and (max-width: 800px) { .a4-page { width: 100%; height: auto; padding: 15mm; } }

        @media print {
            #adminView, #employeeView, .nav-bar, .edit-hint { display: none !important; }
            #previewContainer { display: block !important; background: white; padding: 0; }
            .a4-page { width: 100%; margin: 0; box-shadow: none; padding: 20mm; page-break-after: always; }
            .id-page { page-break-before: always; text-align: center; }
            .footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; border-top: 1px solid #ccc; padding-top: 10px; background: white; }
            [contenteditable="true"]:hover { background: none; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="adminView">
        <div class="admin-header">
            <img src="logo.jpg" style="max-width: 150px;">
            <h3>××¢×¨×›×ª ×—×•×–×™× ×—×›××” (×œ×× ×”×œ)</h3>
        </div>
        
        <div class="input-group">
            <label>×©× ×”×¢×•×‘×“</label>
            <input type="text" id="admName" class="input-field" placeholder="×œ×“×•×’××”: ×™×©×¨××œ ×™×©×¨××œ×™">
        </div>
        <div class="input-group">
            <label>×ª×¢×•×“×ª ×–×”×•×ª</label>
            <input type="tel" id="admID" class="input-field" placeholder="××¡×¤×¨ ×–×”×•×ª">
        </div>
        <div class="input-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>×©×›×¨ ×œ×©×¢×”</label>
                    <input type="number" id="admSalary" class="input-field" value="35">
                </div>
                <div style="flex:1">
                    <label>××©×¨×”</label>
                    <input type="text" id="admScope" class="input-field" value="××©××¨×•×ª">
                </div>
            </div>
        </div>

        <div class="input-group">
            <button class="toggle-edit-btn" onclick="toggleEditor()">ğŸ“ ×œ×—×¥ ×›××Ÿ ×œ×¢×¨×™×›×ª ×ª×•×›×Ÿ ×”×—×•×–×” (××ª×§×“×)</button>
            <div id="editorContainer" style="display:none;">
                <label>×ª×•×›×Ÿ ×”×—×•×–×” (HTML):</label>
                <textarea id="contractBodyInput" class="text-editor">
<h4 style="border-bottom:1px solid #ccc;">1. ×¢×™×§×¨×™ ×”×”×¡×›×</h4>
<ul>
    <li>×”×¢×•×‘×“ ×™×•×¢×¡×§ ×‘×ª×¤×§×™×“ ××•×›×¨ / ×™×•×¢×¥ ××›×™×¨×•×ª.</li>
    <li>×”×©×›×¨ ×”×©×¢×ª×™: <strong>{{SALARY}} â‚ª</strong>.</li>
    <li>×”×™×§×£ ×”××©×¨×”: {{SCOPE}}.</li>
</ul>

<h4 style="border-bottom:1px solid #ccc;">2. ×”×¦×”×¨×•×ª ×•×”×ª×—×™×™×‘×•×™×•×ª</h4>
<ul>
    <li>×”×¢×•×‘×“ ××¦×”×™×¨ ×¢×œ ×›×©×™×¨×•×ª×• ×œ×¢×‘×•×“×” ×•××ª×—×™×™×‘ ×œ×©××•×¨ ×¡×•×“×™×•×ª.</li>
    <li>×ª× ××™× ×¡×•×¦×™××œ×™×™× (×¤× ×¡×™×”, ×”×‘×¨××”, ×—×•×¤×©×”) ×™×©×•×œ××• ×›×—×•×§.</li>
    <li>×”×•×“×¢×” ××•×§×“××ª ×œ×¡×™×•× ×¢×‘×•×“×” ×ª×™× ×ª×Ÿ ×‘×›×ª×‘ ×¢"×¤ ×—×•×§.</li>
</ul>
<p>×”×¢×•×‘×“ ××ª×—×™×™×‘ ×œ××œ× ××ª ×ª×¤×§×™×“×• ×‘×™×•×©×¨ ×•×‘××¡×™×¨×•×ª.</p>
                </textarea>
                <small style="color:#666;">× ×™×ª×Ÿ ×œ×©× ×•×ª ××ª ×”××œ×œ. ×©×™× ×œ×‘: {{SALARY}} ×•-{{SCOPE}} ×™×•×—×œ×¤×• ××•×˜×•××˜×™×ª ×‘× ×ª×•× ×™× ×©×”×–× ×ª.</small>
            </div>
        </div>
        
        <button class="btn-main" onclick="createLink()">ğŸ”— ×¦×•×¨ ×§×™×©×•×¨ ×•×©×œ×— ×œ×¢×•×‘×“</button>
        <div id="linkResult" style="margin-top:15px; word-break:break-all; display:none; background:#f0f0f0; padding:10px; border-radius:5px;"></div>
    </div>

    <div id="employeeView">
        <div class="wizard-header">MAD PARFUMEUR - ×”×¡×›× ×¢×‘×•×“×”</div>

        <div id="step1" class="step-container active">
            <div class="step-title">×©×œ×•×, <span id="dispNameHeader"></span></div>
            <div class="step-desc">×× × ×•×•×“× ×©×¤×¨×˜×™ ×”×”×¢×¡×§×” × ×›×•× ×™×.</div>
            
            <div class="info-card">
                <div class="info-row"><span class="info-label">×ª×¢×•×“×ª ×–×”×•×ª:</span><span id="dispID"></span></div>
                <div class="info-row"><span class="info-label">×©×›×¨ ×œ×©×¢×”:</span><span id="dispSalary"></span> â‚ª</div>
                <div class="info-row"><span class="info-label">×”×™×§×£ ××©×¨×”:</span><span id="dispScope"></span></div>
                <div class="info-row"><span class="info-label">×ª××¨×™×š:</span><span id="dispDate"></span></div>
            </div>
        </div>

        <div id="step2" class="step-container">
            <div class="step-title">×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</div>
            <div class="step-desc">×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×—×ª×•×.</div>
            <button class="big-btn" id="btnSignTrigger" onclick="openSigPad()"><i class="fas fa-pen-nib"></i> ×œ×—×¥ ×›××Ÿ ×œ×—×ª×™××”</button>
            <img id="previewSig" style="max-width:100%; display:none; margin:10px auto; border:1px solid #eee;">
        </div>

        <div id="step3" class="step-container">
            <div class="step-title">×¦×™×œ×•× ×ª×¢×•×“×”</div>
            <div class="step-desc">×—×•×‘×” ×œ×¦×¨×£ ×¦×™×œ×•× ×ª×¢×•×“×ª ×–×”×•×ª ×•×¡×¤×—.</div>
            <label class="big-btn" id="btnUploadFront">
                <i class="fas fa-id-card"></i> ×¦×œ× ×ª×¢×•×“×” (×§×“××™)
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'imgFront', 'btnUploadFront')">
            </label>
            <label class="big-btn" id="btnUploadBack">
                <i class="fas fa-file-alt"></i> ×¦×œ× ×¡×¤×—
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'imgBack', 'btnUploadBack')">
            </label>
        </div>

        <div class="nav-bar">
            <button class="nav-btn btn-prev" onclick="prevStep()" id="btnPrev" style="display:none;">×—×–×•×¨</button>
            <button class="nav-btn btn-next" onclick="nextStep()" id="btnNext">×”×‘×</button>
        </div>
    </div>

    <div id="sigModal">
        <div class="modal-box">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px;">×—×ª×•× ×‘×ª×•×š ×”××¡×’×¨×ª ×”×œ×‘× ×”</div>
            <canvas id="theCanvas"></canvas>
            <div class="sig-toolbar">
                <button class="nav-btn btn-prev" onclick="clearPad()">× ×§×”</button>
                <button class="nav-btn btn-next" style="background:var(--success);" onclick="savePad()">××™×©×•×¨</button>
            </div>
        </div>
    </div>

    <div id="previewContainer">
        <div class="edit-hint" style="background:#fff3cd; color:#856404; padding:10px; text-align:center; margin-bottom:10px; border-radius:5px;">
            <i class="fas fa-info-circle"></i> × ×™×ª×Ÿ ×œ×œ×—×•×¥ ×¢×œ ×”×˜×§×¡×˜ ×›×“×™ ×œ×ª×§×Ÿ ×©×’×™××•×ª ×œ×¤× ×™ ×”×©××™×¨×”!
        </div>

        <div class="a4-page">
            <div style="text-align:center;">
                <img src="logo.jpg" style="width:180px;">
                <h2 style="text-decoration:underline; margin-bottom:5px;">×”×¡×›× ×¢×‘×•×“×” ××™×©×™</h2>
            </div>
            
            <div contenteditable="true" style="font-size:14px; line-height:1.6; text-align:justify;">
                <p><strong>×©× ×¢×¨×š ×•× ×—×ª× ×‘×™×•×:</strong> <span id="finalDate"></span></p>
                <p><strong>×‘×™×Ÿ: ×—×‘×¨×ª ×××“ ×¤×¨×¤×™×•× ×‘×¢"×</strong> (×œ×”×œ×Ÿ: "×”××¢×¡×™×§") ××¦×“ ××—×“;<br>
                <strong>×œ×‘×™×Ÿ:</strong> <span id="finalName"></span> ×ª.×– <span id="finalID"></span> (×œ×”×œ×Ÿ: "×”×¢×•×‘×“") ××¦×“ ×©× ×™.</p>
                
                <div id="finalContractBody"></div>

                <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="text-align:center;">
                        <img src="signther.jpg" style="width:100px; mix-blend-mode:multiply;"><br>
                        <strong>×”××¢×¡×™×§</strong>
                    </div>
                    <div style="text-align:center;">
                        <img id="finalSigImage" style="max-height:80px;"><br>
                        <strong>×—×ª×™××ª ×”×¢×•×‘×“</strong>
                    </div>
                </div>
            </div>
            <div class="footer">MAD PARFUMEUR LTD | 515456093</div>
        </div>

        <div class="a4-page id-page">
            <h3>× ×¡×¤×—: ××¡××›×™× ××–×”×™×</h3>
            <div style="margin-top:20px;">
                <img id="finalImgFront" style="max-width:90%; border:1px solid #ccc; margin-bottom:20px;">
                <br>
                <img id="finalImgBack" style="max-width:90%; border:1px solid #ccc;">
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let empData = {};
        let sigDataUrl = null;
        let imgFrontUrl = null;
        let imgBackUrl = null; // Add image back url variable

        // On Load
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('d')) {
                // Employee Mode
                document.getElementById('adminView').style.display = 'none';
                document.getElementById('employeeView').style.display = 'flex';
                
                try {
                    const json = decodeURIComponent(escape(atob(params.get('d'))));
                    empData = JSON.parse(json);
                    
                    // Fill Data
                    document.getElementById('dispNameHeader').innerText = empData.n.split(' ')[0];
                    document.getElementById('dispID').innerText = empData.i;
                    document.getElementById('dispSalary').innerText = empData.s;
                    document.getElementById('dispScope').innerText = empData.sc;
                    document.getElementById('dispDate').innerText = new Date().toLocaleDateString('he-IL');

                    document.getElementById('finalName').innerText = empData.n;
                    document.getElementById('finalID').innerText = empData.i;
                    document.getElementById('finalDate').innerText = new Date().toLocaleDateString('he-IL');

                    // Fill Body with Replacements
                    let body = empData.body;
                    body = body.replace(/{{SALARY}}/g, empData.s);
                    body = body.replace(/{{SCOPE}}/g, empData.sc);
                    document.getElementById('finalContractBody').innerHTML = body;

                } catch(e) { alert('×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ'); }
            }
        };

        // Admin: Toggle Editor
        function toggleEditor() {
            const el = document.getElementById('editorContainer');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // Admin: Generate Link
        function createLink() {
            const data = {
                n: document.getElementById('admName').value,
                i: document.getElementById('admID').value,
                s: document.getElementById('admSalary').value,
                sc: document.getElementById('admScope').value,
                body: document.getElementById('contractBodyInput').value // Get custom text
            };
            
            if(!data.n || !data.i) return alert('× × ×œ××œ× ×¤×¨×˜×™×');
            
            // Encode
            const str = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            const link = window.location.href.split('?')[0] + '?d=' + str;
            
            const res = document.getElementById('linkResult');
            res.style.display = 'block';
            res.innerHTML = `<strong>×©×œ×—:</strong><br><a href="${link}">${link}</a>`;
            navigator.clipboard.writeText(link);
            alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!');
        }

        // Wizard
        function nextStep() {
            if(currentStep === 2 && !sigDataUrl) return alert('×—×•×‘×” ×œ×—×ª×•×');
            if(currentStep === 3) {
                if(!imgFrontUrl) return alert('×—×•×‘×” ×œ×¦×¨×£ ×ª×¢×•×“×”');
                
                // Show Final Preview
                document.getElementById('employeeView').style.display = 'none';
                document.getElementById('previewContainer').style.display = 'block';
                setTimeout(() => window.print(), 800);
                return;
            }
            document.getElementById('step'+currentStep).classList.remove('active');
            currentStep++;
            document.getElementById('step'+currentStep).classList.add('active');
            
            document.getElementById('btnPrev').style.display = 'block';
            if(currentStep === 3) document.getElementById('btnNext').innerText = '×¡×™×•× ×•×©××™×¨×” (PDF)';
        }

        function prevStep() {
            document.getElementById('step'+currentStep).classList.remove('active');
            currentStep--;
            document.getElementById('step'+currentStep).classList.add('active');
            if(currentStep === 1) document.getElementById('btnPrev').style.display = 'none';
            document.getElementById('btnNext').innerText = '×”×‘×';
        }

        // Signature
        const sigModal = document.getElementById('sigModal');
        const canvas = document.getElementById('theCanvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight - 60;
        }

        function openSigPad() {
            sigModal.style.display = 'flex';
            resizeCanvas();
        }

        function startDraw(e) { painting = true; draw(e); }
        function endDraw() { painting = false; ctx.beginPath(); }
        function draw(e) {
            if(!painting) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.lineWidth = 3; ctx.lineCap = 'round';
            ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }

        canvas.addEventListener('touchstart', startDraw, {passive:false});
        canvas.addEventListener('touchend', endDraw);
        canvas.addEventListener('touchmove', draw, {passive:false});
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mousemove', draw);

        function clearPad() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function savePad() {
            sigDataUrl = canvas.toDataURL();
            document.getElementById('previewSig').src = sigDataUrl;
            document.getElementById('previewSig').style.display = 'block';
            document.getElementById('finalSigImage').src = sigDataUrl;
            document.getElementById('btnSignTrigger').classList.add('done');
            document.getElementById('btnSignTrigger').innerHTML = '<i class="fas fa-check"></i> × ×—×ª×';
            sigModal.style.display = 'none';
        }

        // Image
        function handleImg(input, targetID, btnID) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (targetID === 'imgFront') imgFrontUrl = e.target.result; // Store URL
                    else if (targetID === 'imgBack') imgBackUrl = e.target.result; // Store URL

                    document.getElementById('final'+targetID.charAt(0).toUpperCase() + targetID.slice(1)).src = e.target.result;
                    document.getElementById(btnID).classList.add('done');
                    document.getElementById(btnID).innerHTML = '<i class="fas fa-check"></i> ×¦×•×¨×£';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>
