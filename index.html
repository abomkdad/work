<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD System - WhatsApp Ready</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <style>
        :root { --primary: #D4AF37; --dark: #2c3e50; --light: #f8f9fa; --success: #25D366; /* WhatsApp Green */ }
        body { margin: 0; padding: 0; font-family: 'Assistant', sans-serif; background: var(--light); color: #333; }
        
        /* Admin */
        #adminView { max-width: 800px; margin: 20px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        .editor-container { border: 2px solid var(--primary); border-radius: 8px; background: #fff; height: 400px; overflow-y: auto; padding: 20px; margin-top: 15px; }
        #editorBody { outline: none; line-height: 1.6; font-size: 14px; text-align: justify; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--dark); color: var(--primary); border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-whatsapp { background: var(--success); color: white; margin-top: 10px; } /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± */

        /* Employee */
        #employeeView { display: none; height: 100vh; flex-direction: column; }
        .wizard-header { background: var(--dark); color: white; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; }
        .step-container { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        
        .big-btn { width: 100%; padding: 20px; margin-bottom: 15px; border: 2px dashed #ccc; border-radius: 12px; background: white; font-size: 18px; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .big-btn.done { border-color: var(--success); color: var(--success); background: #e8f8f5; border-style: solid; }
        
        .nav-bar { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-next { background: var(--dark); color: white; }
        
        /* Signature */
        #sigModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; flex-direction: column; }
        canvas { flex: 1; width: 100%; background: #fff; touch-action: none; cursor: crosshair; }
        
        /* Preview */
        #previewContainer { display: none; background: #555; padding: 10px; }
        .a4-page { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm; box-sizing: border-box; position: relative; }
        
        /* Final Action Bar (New) */
        .final-actions {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); display: flex; gap: 10px; z-index: 1000;
        }
        
        @media screen and (max-width: 800px) { .a4-page { width: 100%; height: auto; padding: 15mm; } }
        @media print {
            #adminView, #employeeView, .nav-bar, .final-actions { display: none !important; }
            #previewContainer { display: block !important; background: white; padding: 0; }
            .a4-page { width: 100%; margin: 0; box-shadow: none; padding: 20mm; page-break-after: always; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="adminView">
        <div class="admin-header" style="text-align:center;">
            <img src="logo.jpg" style="max-width: 120px;">
            <h2>××¢×¨×›×ª ×—×•×–×™× (×œ×× ×”×œ)</h2>
        </div>
        
        <div class="input-row">
            <div class="input-group"><label>×©× ×”×¢×•×‘×“</label><input type="text" id="admName" class="input-field" placeholder="×™×©×¨××œ ×™×©×¨××œ×™"></div>
            <div class="input-group"><label>×ª×¢×•×“×ª ×–×”×•×ª</label><input type="tel" id="admID" class="input-field"></div>
        </div>
        <div class="input-row">
            <div class="input-group"><label>×©×›×¨ ×œ×©×¢×”</label><input type="number" id="admSalary" class="input-field" value="35"></div>
            <div class="input-group"><label>××©×¨×”</label><input type="text" id="admScope" class="input-field" value="××©××¨×•×ª"></div>
        </div>

        <label style="font-weight:bold;">×ª×•×›×Ÿ ×”×—×•×–×” (×¢×¨×•×š ×›××Ÿ):</label>
        <div class="editor-container">
            <div id="editorBody" contenteditable="true">
                <h2 style="text-align:center; text-decoration:underline;">×”×¡×›× ×¢×‘×•×“×” ××™×©×™</h2>
                <p style="text-align:center;">×©× ×¢×¨×š ×•× ×—×ª× ×‘×—×“×¨×” ×‘×™×•× <strong>{{DATE}}</strong></p>
                <p><strong>×‘×™×Ÿ: ×—×‘×¨×ª ×××“ ×¤×¨×¤×™×•× ×‘×¢"× (MAD PARFUMEUR)</strong>, ×—.×¤ 515456093 (×œ×”×œ×Ÿ: "<strong>×”××¢×¡×™×§</strong>") ××¦×“ ××—×“;</p>
                <p><strong>×œ×‘×™×Ÿ: {{NAME}}</strong>, ×ª.×– <strong>{{ID}}</strong> (×œ×”×œ×Ÿ: "<strong>×”×¢×•×‘×“</strong>") ××¦×“ ×©× ×™.</p>
                <h3>1. ×ª×¤×§×™×“ ×•×¡××›×•×™×•×ª</h3>
                <ul><li>×”×¢×•×‘×“ ×™×•×¢×¡×§ ×‘×ª×¤×§×™×“ <strong>××•×›×¨ / ×™×•×¢×¥ ××›×™×¨×•×ª</strong>.</li></ul>
                <h3>2. ×©×›×¨ ×•×ª× ××™×</h3>
                <ul><li>×©×›×¨ ×œ×©×¢×”: <strong>{{SALARY}} â‚ª</strong> (×‘×¨×•×˜×•).</li><li>×”×™×§×£ ××©×¨×”: <strong>{{SCOPE}}</strong>.</li></ul>
                <h3>3. ×”×¦×”×¨×•×ª</h3>
                <ul><li>×”×¢×•×‘×“ ××¦×”×™×¨ ×¢×œ ×›×©×™×¨×•×ª×• ×•××ª×—×™×™×‘ ×œ×©××•×¨ ×¡×•×“×™×•×ª.</li></ul>
                <p style="margin-top:30px;"><strong>×•×œ×¨××™×” ×‘××• ×”×¦×“×“×™× ×¢×œ ×”×—×ª×•×:</strong></p>
            </div>
        </div>
        
        <button class="btn-main" onclick="createLink(false)">ğŸ”— ×”×¢×ª×§ ×§×™×©×•×¨ (Copy Link)</button>
        <button class="btn-main btn-whatsapp" onclick="createLink(true)">
            <i class="fab fa-whatsapp"></i> ×©×œ×— ×‘×•×•××˜×¡××¤ (Send WhatsApp)
        </button>
        <div id="linkResult" style="margin-top:15px; word-break:break-all; display:none; background:#eee; padding:10px; text-align:center;"></div>
    </div>

    <div id="employeeView">
        <div class="wizard-header">MAD PARFUMEUR - ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</div>

        <div id="step1" class="step-container active">
            <h2 style="text-align:center;">×©×œ×•×, <span id="dispNameHeader"></span></h2>
            <div class="info-card" style="background:white; padding:15px; border-radius:10px;">
                <p><strong>×ª.×–:</strong> <span id="dispID"></span></p>
                <p><strong>×©×›×¨:</strong> <span id="dispSalary"></span> â‚ª</p>
                <p><strong>××©×¨×”:</strong> <span id="dispScope"></span></p>
            </div>
        </div>

        <div id="step2" class="step-container">
            <h2 style="text-align:center;">×—×ª×™××”</h2>
            <button class="big-btn" id="btnSignTrigger" onclick="openSigPad()"><i class="fas fa-pen-nib"></i> ×œ×—×¥ ×›××Ÿ ×œ×—×ª×™××”</button>
            <img id="previewSig" style="max-width:100%; display:none; margin:10px auto;">
        </div>

        <div id="step3" class="step-container">
            <h2 style="text-align:center;">×¦×™×œ×•× ××¡××›×™×</h2>
            <label class="big-btn" id="btnUploadFront">
                <i class="fas fa-id-card"></i> ×¦×œ× ×ª×¢×•×“×”
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'imgFront', 'btnUploadFront')">
            </label>
            <label class="big-btn" id="btnUploadBack">
                <i class="fas fa-file-alt"></i> ×¦×œ× ×¡×¤×—
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'imgBack', 'btnUploadBack')">
            </label>
        </div>

        <div class="nav-bar">
            <button class="nav-btn" style="background:#eee; color:#333; display:none;" id="btnPrev" onclick="prevStep()">×—×–×•×¨</button>
            <button class="nav-btn btn-next" onclick="nextStep()" id="btnNext">×”×‘×</button>
        </div>
    </div>

    <div id="sigModal">
        <div style="padding:10px; text-align:center; font-weight:bold;">×—×ª×•× ×›××Ÿ</div>
        <canvas id="theCanvas"></canvas>
        <div style="padding:10px; display:flex; gap:10px;">
            <button class="nav-btn" style="background:#e74c3c; color:white;" onclick="clearPad()">× ×§×”</button>
            <button class="nav-btn" style="background:var(--success); color:white;" onclick="savePad()">××™×©×•×¨</button>
        </div>
    </div>

    <div id="previewContainer">
        <div class="a4-page">
            <div style="text-align:center;"><img src="logo.jpg" style="width:150px;"></div>
            <div id="finalContractBody" style="display:block; min-height:100px;"></div>
            <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:flex-end;">
                <div style="text-align:center;"><img src="signther.jpg" style="width:100px; mix-blend-mode:multiply;"><br><strong>×”××¢×¡×™×§</strong></div>
                <div style="text-align:center;"><img id="finalSigImage" style="max-height:80px;"><br><strong>×—×ª×™××ª ×”×¢×•×‘×“</strong></div>
            </div>
            <div style="position:fixed; bottom:0; width:100%; text-align:center; font-size:10px; border-top:1px solid #ccc;">MAD PARFUMEUR LTD</div>
        </div>
        <div class="a4-page id-page" style="page-break-before:always; text-align:center;">
            <h3>× ×¡×¤×—: ××¡××›×™× ××–×”×™×</h3>
            <img id="finalImgFront" style="max-width:90%; margin-bottom:20px;"><br>
            <img id="finalImgBack" style="max-width:90%;">
        </div>
    </div>

    <div class="final-actions" id="finalActions" style="display:none;">
        <button class="nav-btn" style="background:var(--dark); color:white;" onclick="window.print()">
            <i class="fas fa-print"></i> ×©××•×¨ ×›-PDF
        </button>
        <button class="nav-btn" style="background:var(--success); color:white;" onclick="sendWhatsappToBoss()">
            <i class="fab fa-whatsapp"></i> ×¢×“×›×Ÿ ×× ×”×œ
        </button>
    </div>

    <script>
        let currentStep = 1;
        let empData = {};
        let sigDataUrl = null;
        let imgFrontUrl = null;
        let imgBackUrl = null;

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const today = new Date().toLocaleDateString('he-IL');
            if(document.getElementById('editorBody')) {
                document.getElementById('editorBody').innerHTML = document.getElementById('editorBody').innerHTML.replace('{{DATE}}', today);
            }

            if(params.has('d')) {
                document.getElementById('adminView').style.display = 'none';
                document.getElementById('employeeView').style.display = 'flex';
                
                try {
                    const json = LZString.decompressFromEncodedURIComponent(params.get('d'));
                    if(!json) throw new Error();
                    empData = JSON.parse(json);
                    
                    document.getElementById('dispNameHeader').innerText = empData.n.split(' ')[0];
                    document.getElementById('dispID').innerText = empData.i;
                    document.getElementById('dispSalary').innerText = empData.s;
                    document.getElementById('dispScope').innerText = empData.sc;

                    let content = empData.body;
                    content = content.replace(/{{NAME}}/g, empData.n).replace(/{{ID}}/g, empData.i).replace(/{{SALARY}}/g, empData.s).replace(/{{SCOPE}}/g, empData.sc).replace(/{{DATE}}/g, today);
                    document.getElementById('finalContractBody').innerHTML = content;
                } catch(e) { alert('×§×™×©×•×¨ ×©×‘×•×¨. ×‘×§×© ×§×™×©×•×¨ ×—×“×©.'); }
            }
        };

        function createLink(isWhatsapp) {
            const html = document.getElementById('editorBody').innerHTML;
            const data = {
                n: document.getElementById('admName').value,
                i: document.getElementById('admID').value,
                s: document.getElementById('admSalary').value,
                sc: document.getElementById('admScope').value,
                body: html
            };
            
            if(!data.n) return alert('× × ×œ××œ× ×©×');
            
            const str = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            const link = window.location.href.split('?')[0] + '?d=' + str;
            
            if(isWhatsapp) {
                // Open WhatsApp directly
                const msg = `×©×œ×•× ${data.n}, ×‘×‘×§×©×” ×”×™×›× ×¡ ×œ×§×™×©×•×¨ ×”×‘× ×›×“×™ ×œ×—×ª×•× ×¢×œ ×”×¡×›× ×”×¢×‘×•×“×”:\n${link}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            } else {
                // Copy Link
                const res = document.getElementById('linkResult');
                res.style.display = 'block';
                res.innerHTML = `<strong>×”×¢×ª×§:</strong><br><a href="${link}">${link}</a>`;
                navigator.clipboard.writeText(link).then(() => alert('×”×•×¢×ª×§!'));
            }
        }

        function nextStep() {
            if(currentStep === 2 && !sigDataUrl) return alert('×—×•×‘×” ×œ×—×ª×•×');
            if(currentStep === 3) {
                if(!imgFrontUrl) return alert('×—×•×‘×” ×œ×¦×¨×£ ×ª×¢×•×“×”');
                document.getElementById('employeeView').style.display = 'none';
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('finalActions').style.display = 'flex'; // Show final buttons
                return;
            }
            document.getElementById('step'+currentStep).classList.remove('active');
            currentStep++;
            document.getElementById('step'+currentStep).classList.add('active');
            document.getElementById('btnPrev').style.display = 'block';
        }

        function prevStep() {
            document.getElementById('step'+currentStep).classList.remove('active');
            currentStep--;
            document.getElementById('step'+currentStep).classList.add('active');
            if(currentStep === 1) document.getElementById('btnPrev').style.display = 'none';
        }

        // Signature
        const sigModal = document.getElementById('sigModal');
        const canvas = document.getElementById('theCanvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function openSigPad() { sigModal.style.display = 'flex'; canvas.width = window.innerWidth; canvas.height = window.innerHeight - 100; }
        function clearPad() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function startDraw(e) { painting = true; draw(e); }
        function endDraw() { painting = false; ctx.beginPath(); }
        function draw(e) {
            if(!painting) return; e.preventDefault();
            const x = (e.clientX||e.touches[0].clientX); const y = (e.clientY||e.touches[0].clientY) - 50;
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }
        canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchmove', draw, {passive:false});
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mousemove', draw);

        function savePad() {
            sigDataUrl = canvas.toDataURL();
            document.getElementById('previewSig').src = sigDataUrl; document.getElementById('previewSig').style.display = 'block';
            document.getElementById('finalSigImage').src = sigDataUrl;
            document.getElementById('btnSignTrigger').classList.add('done'); document.getElementById('btnSignTrigger').innerHTML = '× ×—×ª× âœ“';
            sigModal.style.display = 'none';
        }

        function handleImg(input, targetID, btnID) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(targetID==='imgFront') imgFrontUrl=e.target.result;
                    document.getElementById('final'+targetID.charAt(0).toUpperCase()+targetID.slice(1)).src = e.target.result;
                    document.getElementById(btnID).classList.add('done'); document.getElementById(btnID).innerHTML = '×¦×•×¨×£ âœ“';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function sendWhatsappToBoss() {
            // Note: Cannot attach PDF directly via web link without backend.
            // Best practice: Instruct user to save PDF then send.
            const msg = "×”×™×™, ×—×ª××ª×™ ×¢×œ ×”×—×•×–×”. ×× ×™ ×©×•×œ×— ×œ×š ××ª ×”-PDF ×¢×›×©×™×•.";
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
