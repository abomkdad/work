<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD Secure Contract</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <style>
        :root { --gold: #D4AF37; --dark: #2c3e50; --bg: #f8f9fa; --green: #25D366; }
        body { margin:0; padding:0; font-family:'Assistant',sans-serif; background:var(--bg); color:#333; }
        
        /* --- Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø§Øª --- */
        .view-section { display: none; padding: 20px; max-width: 800px; margin: 0 auto; }
        .view-section.active { display: block; animation: fade 0.3s; }
        
        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¯ÙŠØ± --- */
        .admin-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-top: 5px solid var(--gold); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* Ù…Ø­Ø±Ø± Ø§Ù„Ø¹Ù‚Ø¯ */
        .editor-box { 
            width: 100%; height: 300px; padding: 15px; border: 2px solid var(--gold); 
            border-radius: 8px; overflow-y: auto; background: white; text-align: justify;
        }
        
        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¸Ù --- */
        .read-only-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #555; font-weight: bold; border: 1px solid #ccc; }
        .contract-preview { background: white; padding: 20px; border: 1px solid #ccc; height: 300px; overflow-y: auto; font-size: 14px; margin-bottom: 20px; }
        
        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-green { background: var(--green); color: white; }
        .btn-upload { background: white; border: 2px dashed #ccc; color: #555; }
        .btn-upload.done { border-color: var(--green); color: var(--green); background: #f0fff4; }

        /* --- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ --- */
        #sigModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: none; flex-direction: column; }
        canvas { flex: 1; border: 1px solid #eee; }
        .sig-tools { padding: 10px; display: flex; gap: 10px; }

        /* --- Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        #printArea { display: none; }
        .a4-page { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm; position: relative; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; display: block !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .a4-page { box-shadow: none; margin: 0; page-break-after: always; }
        }
        @keyframes fade { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <div id="adminView" class="view-section">
        <div class="admin-card">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="logo.jpg" style="max-width:120px;">
                <h2>××¢×¨×›×ª ×—×•×–×™× (×× ×”×œ)</h2>
            </div>

            <div class="input-group">
                <label>×©× ×”×¢×•×‘×“:</label>
                <input type="text" id="admName" class="input-field" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
            </div>
            <div class="input-group">
                <label>×ª×¢×•×“×ª ×–×”×•×ª:</label>
                <input type="tel" id="admID" class="input-field">
            </div>
            <div class="input-group">
                <label>×©×›×¨ ×œ×©×¢×” (â‚ª):</label>
                <input type="number" id="admSalary" class="input-field" value="35">
            </div>

            <label>×ª×•×›×Ÿ ×”×—×•×–×” (× ×™×ª×Ÿ ×œ×¢×¨×•×š ×”×›×œ ×›××Ÿ):</label>
            <div id="contractEditor" class="editor-box" contenteditable="true">
                <h3 style="text-align:center; text-decoration:underline;">×”×¡×›× ×¢×‘×•×“×” ××™×©×™</h3>
                <p><strong>×‘×™×Ÿ: ×—×‘×¨×ª ×××“ ×¤×¨×¤×™×•× ×‘×¢"×</strong> (×”××¢×¡×™×§) <br> <strong>×œ×‘×™×Ÿ: {{NAME}}</strong>, ×ª.×– {{ID}} (×”×¢×•×‘×“)</p>
                <h4>1. ×ª×¤×§×™×“ ×•×©×›×¨</h4>
                <ul>
                    <li>×”×¢×•×‘×“ ×™×•×¢×¡×§ ×‘×ª×¤×§×™×“ <strong>××•×›×¨ / ×™×•×¢×¥ ××›×™×¨×•×ª</strong>.</li>
                    <li>×©×›×¨ ×”×‘×¡×™×¡: <strong>{{SALARY}} â‚ª ×œ×©×¢×”</strong>.</li>
                    <li>×”×™×§×£ ×”××©×¨×”: ××©××¨×•×ª.</li>
                </ul>
                <h4>2. ×ª×§×•×¤×ª ×”×¢×¡×§×”</h4>
                <ul><li>×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ: 3-6 ×—×•×“×©×™×. ×”×•×“×¢×” ××•×§×“××ª ×›×—×•×§.</li></ul>
                <h4>3. ×¡×•×“×™×•×ª</h4>
                <ul><li>×”×¢×•×‘×“ ××ª×—×™×™×‘ ×œ×©××•×¨ ×¢×œ ×¡×•×“×™×•×ª ××•×—×œ×˜×ª.</li></ul>
                <p style="margin-top:20px;">×•×œ×¨××™×” ×‘××• ×”×¦×“×“×™× ×¢×œ ×”×—×ª×•×:</p>
            </div>

            <button class="btn btn-green" onclick="generateAndSend()">
                <i class="fab fa-whatsapp"></i> ×¦×•×¨ ×•×©×œ×— ×‘×•×•××˜×¡××¤ (Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„)
            </button>
        </div>
    </div>

    <div id="employeeView" class="view-section">
        <div style="text-align:center;">
            <img src="logo.jpg" style="max-width:100px;">
            <h3>×—×ª×™××” ×¢×œ ×”×¡×›× ×¢×‘×•×“×”</h3>
        </div>

        <p>×©×œ×•× <strong><span id="empNameDisplay"></span></strong>, ×× × ×¢×™×™×Ÿ ×‘×¤×¨×˜×™×:</p>
        
        <div class="read-only-box">
            <div>×ª.×–: <span id="empIDDisplay"></span></div>
            <div>×©×›×¨: <span id="empSalaryDisplay"></span> â‚ª</div>
        </div>

        <p>×ª×•×›×Ÿ ×”×—×•×–×”:</p>
        <div id="empContractView" class="contract-preview"></div>

        <button class="btn btn-gold" id="btnSign" onclick="openSigPad()">ğŸ–‹ ×œ×—×¥ ×œ×—×ª×™××” (Sign)</button>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <label class="btn btn-upload" id="btnFront">
                ğŸ“· ×ª×¢×•×“×”
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'front')">
            </label>
            <label class="btn btn-upload" id="btnBack">
                ğŸ“„ ×¡×¤×—
                <input type="file" hidden accept="image/*" onchange="handleImg(this, 'back')">
            </label>
        </div>

        <button class="btn btn-green" onclick="finishProcess()">âœ… ×¡×™×•× ×•×©××™×¨×” (Finish)</button>
    </div>

    <div id="sigModal">
        <div style="padding:15px; text-align:center; font-weight:bold; background:#eee;">×—×ª×•× ×›××Ÿ</div>
        <canvas id="theCanvas"></canvas>
        <div class="sig-tools">
            <button class="btn" style="background:#e74c3c; color:white;" onclick="clearPad()">× ×§×”</button>
            <button class="btn" style="background:var(--green); color:white;" onclick="savePad()">××™×©×•×¨</button>
        </div>
    </div>

    <div id="printArea">
        <div class="a4-page">
            <div style="text-align:center;"><img src="logo.jpg" width="150"></div>
            <div id="finalContractBody"></div>
            <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:flex-end;">
                <div style="text-align:center;"><img src="signther.jpg" width="120"><br><strong>×”××¢×¡×™×§</strong></div>
                <div style="text-align:center;"><img id="finalSig" height="80"><br><strong>×—×ª×™××ª ×”×¢×•×‘×“</strong></div>
            </div>
        </div>
        <div class="a4-page" style="text-align:center;">
            <h3>× ×¡×¤×—: ××¡××›×™× ××–×”×™×</h3>
            <img id="finalImgFront" style="max-width:90%; margin-bottom:20px;"><br>
            <img id="finalImgBack" style="max-width:90%;">
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ ---
        let contractData = {};
        
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const dataStr = params.get('d');

            if (dataStr) {
                // ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù (ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±)
                try {
                    const json = LZString.decompressFromEncodedURIComponent(dataStr);
                    contractData = JSON.parse(json);
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
                    document.getElementById('adminView').classList.remove('active');
                    document.getElementById('employeeView').classList.add('active');

                    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
                    document.getElementById('empNameDisplay').innerText = contractData.n;
                    document.getElementById('empIDDisplay').innerText = contractData.i;
                    document.getElementById('empSalaryDisplay').innerText = contractData.s;

                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ
                    let body = contractData.b;
                    body = body.replace(/{{NAME}}/g, contractData.n)
                               .replace(/{{ID}}/g, contractData.i)
                               .replace(/{{SALARY}}/g, contractData.s);
                    
                    document.getElementById('empContractView').innerHTML = body; // Ù„Ù„Ø¹Ø±Ø¶
                    document.getElementById('finalContractBody').innerHTML = body; // Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©

                } catch (e) {
                    alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­");
                    window.location.href = window.location.href.split('?')[0]; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¯ÙŠØ±
                }
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±
                document.getElementById('adminView').classList.add('active');
            }
        };

        // --- 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù…Ù†) ---
        function generateAndSend() {
            const name = document.getElementById('admName').value;
            const id = document.getElementById('admID').value;
            const salary = document.getElementById('admSalary').value;
            const body = document.getElementById('contractEditor').innerHTML;

            if(!name || !id) { alert("× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™×"); return; }

            const data = { n: name, i: id, s: salary, b: body };
            
            // Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ´ÙÙŠØ± (Ù‡Ù†Ø§ Ø§Ù„Ø³Ø± ÙÙŠ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆÙ‚ØµØ± Ø§Ù„Ø±Ø§Ø¨Ø·)
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            const link = window.location.href.split('?')[0] + '?d=' + compressed;

            // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
            const msg = `×”×™×™ ${name}, ×œ×—×¥ ×›××Ÿ ×œ×—×ª×™××” ×¢×œ ×”×”×¡×›×:\n${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¸Ù ---
        let sigURL = null, imgFront = null, imgBack = null;

        // Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
        const modal = document.getElementById('sigModal');
        const canvas = document.getElementById('theCanvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function openSigPad() { 
            modal.style.display = 'flex'; 
            canvas.width = window.innerWidth; canvas.height = window.innerHeight - 100;
        }
        function clearPad() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        
        function draw(e) {
            if(!painting) return; e.preventDefault();
            const x = (e.clientX||e.touches[0].clientX); const y = (e.clientY||e.touches[0].clientY) - 50;
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }
        canvas.addEventListener('mousedown', ()=>{painting=true; draw(event)});
        canvas.addEventListener('mouseup', ()=>{painting=false; ctx.beginPath()});
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', ()=>{painting=true; draw(event.touches[0])}, {passive:false});
        canvas.addEventListener('touchend', ()=>{painting=false; ctx.beginPath()});
        canvas.addEventListener('touchmove', (e)=>{draw(e.touches[0])}, {passive:false});

        function savePad() {
            sigURL = canvas.toDataURL();
            document.getElementById('finalSig').src = sigURL;
            document.getElementById('btnSign').classList.add('done');
            document.getElementById('btnSign').innerText = '× ×—×ª× ×‘×”×¦×œ×—×” âœ“';
            modal.style.display = 'none';
        }

        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        function handleImg(input, type) {
            if(input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(type === 'front') { 
                        imgFront = true; 
                        document.getElementById('finalImgFront').src = e.target.result;
                        document.getElementById('btnFront').classList.add('done');
                    } else { 
                        imgBack = true; 
                        document.getElementById('finalImgBack').src = e.target.result;
                        document.getElementById('btnBack').classList.add('done');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
        function finishProcess() {
            if(!sigURL) return alert('×—×•×‘×” ×œ×—×ª×•×');
            if(!imgFront) return alert('×—×•×‘×” ×œ×¦×¨×£ ×ª×¢×•×“×”');
            
            // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            window.print();
            
            // Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¯ÙŠØ±
            setTimeout(() => {
                const msg = "×¡×™×™××ª×™ ×œ×—×ª×•×. ×©×•×œ×— ×œ×š ××ª ×”-PDF.";
                if(confirm("×”×× ×œ×¤×ª×•×— ×•×•××˜×¡××¤ ×œ×× ×”×œ?")) {
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }, 1000);
        }
    </script>
</body>
</html>
